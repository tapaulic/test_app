var cot_login_app,cot_login=function(o){if(this.options=$.extend({appName:"",ccRoot:"",welcomeSelector:"",onReady:function(o){},onLogin:function(o){}},o||{}),!this.options.appName)throw new Error("Error: the appName option is required");this.session=new CotSession({appName:this.options.appName,ccApiOrigin:this.options.ccRoot});var i=this;$("#app-utility-login").load("html/cot_login.html? #loginModal",function(){i.modal=$("#loginModal"),i.modal.find("#cot_login").click(function(){i._login()}),i.modal.find("input").keydown(function(o){13===(o.charCode||o.keyCode||0)&&i._login()}),i._setUserName(),i.options.onReady(i)})};cot_login.prototype.showLogin=function(){this.modal.modal()},cot_login.prototype.isLoggedIn=function(){return this.session.isLoggedIn()},cot_login.prototype.logout=function(){this.session.logout(),this._setUserName(),window.location.reload()},cot_login.prototype._setUserName=function(){this._loadSessionFields(),cot_login_app=this,this.isLoggedIn()?($(this.options.welcomeSelector).html("<div class='welcomemsg'><b>User Name</b>: "+this.username+" (<a class='logout' onclick='cot_login_app.logout();'>Logout</a>)</div>"),this.options.onLogin(this)):$(this.options.welcomeSelector).html("<div class='welcomemsg'><a class='login' onclick='cot_login_app.showLogin();'>Login</a></div>")},cot_login.prototype._login=function(){var o=this;this.modal.find(".btn").prop("disabled",!0),this.session.login({username:$("#username").val(),password:$("#password").val(),success:function(){o._setUserName(),o.modal.modal("hide")},error:function(i,s,e){console.log("POST Request Failed: "+s+", "+e,arguments),"invalid_user_or_pwd"===e?o._displayLoginError(s):o._displayLoginError("Unable to log in. Please try again.")},always:function(){o.modal.find(".btn").removeAttr("disabled").removeClass("disabled")}})},cot_login.prototype._loadSessionFields=function(){var o=this;["sid","username","email","firstName","lastName","division","groups"].forEach(function(i){o[i]=o.session[i]})},cot_login.prototype._displayLoginError=function(o){$('<div class="alert alert-danger" role="alert">'+o+"</div>").prependTo(this.modal.find("#loginModalBody")).fadeOut(5e3,function(){$(this).remove()})};var CotSession=function(o){if(this.options=$.extend({appName:"",ccApiOrigin:"",ccApiPath:"/cc_sr_admin_v1/"},o||{}),!this.options.appName)throw new Error("Error: the appName option is required");this._loadSessionFromCookie()};CotSession.LOGIN_CHECK_RESULT_TRUE=1,CotSession.LOGIN_CHECK_RESULT_FALSE=2,CotSession.LOGIN_CHECK_RESULT_INDETERMINATE=3,CotSession.prototype.isLoggedIn=function(o){if(!o)return!!this._cookie("sid")||(this.logout(),!1);var i=this.sid||this._cookie("sid");if(i){var s=this.options.ccApiOrigin+this.options.ccApiPath+"session/"+i,e=this;$.get(s,function(s){var t=s.app||"",n=s.sid||"",r=s.error||"";t===e.options.appName&&n===i?(e._storeLogin(s),o(CotSession.LOGIN_CHECK_RESULT_TRUE)):"no_such_session"===r?(e.logout(),o(CotSession.LOGIN_CHECK_RESULT_FALSE)):o(CotSession.LOGIN_CHECK_RESULT_INDETERMINATE)}).fail(function(i,s,e){console.log("Unable to test session. jqXHR:",i,"textStatus:",s,"error:",e),o(CotSession.LOGIN_CHECK_RESULT_INDETERMINATE)})}else o(CotSession.LOGIN_CHECK_RESULT_FALSE)},CotSession.prototype.login=function(o){o=$.extend({username:"",password:"",success:function(){},error:function(o,i,s){},always:function(){}},o||{});var i=this.options.ccApiOrigin+this.options.ccApiPath+"session?app="+this.options.appName,s={user:o.username,pwd:o.password},e=this;$.post(i,s,function(i){i.error?"invalid_user_or_pwd"===i.error&&o.error(null,"Invalid username or password",i.error):(e._storeLogin(i),o.success())}).fail(function(i,s,e){o.error(i,s,e)}).always(function(){o.always()})},CotSession.prototype.logout=function(){this._removeCookie("sid"),this._removeCookie("cot_uname"),this._removeCookie("email"),this._removeCookie("firstName"),this._removeCookie("lastName"),this._removeCookie("division"),this._removeCookie("groups"),this._loadSessionFromCookie()},CotSession.prototype.extend=function(o){return!!this.sid&&(this._storeLogin({passwordExpiryDate:o?(new Date).getTime()+60*o*1e3:null,sid:this.sid,userID:this.username||"",email:this.email||"",cotUser:{firstName:this.firstName||"",lastName:this.lastName||"",division:this.division||"",groupMemberships:this.groups||""}}),!0)},CotSession.prototype._loadSessionFromCookie=function(){this.sid=this._cookie("sid")||"",this.username=this._cookie("cot_uname")||"",this.email=this._cookie("email")||"",this.firstName=this._cookie("firstName")||"",this.lastName=this._cookie("lastName")||"",this.division=this._cookie("division")||"",this.groups=this._cookie("groups")||""},CotSession.prototype._storeLogin=function(o){var i=new Date;o.passwordExpiryDate?i.setTime(o.passwordExpiryDate):i.setTime(i.getTime()+18e5),this._cookie("sid",o.sid,{expires:i}),this._cookie("cot_uname",o.userID,{expires:i}),this._cookie("email",(o.email||"").toLowerCase(),{expires:i}),o.cotUser&&(this._cookie("firstName",o.cotUser.firstName,{expires:i}),this._cookie("lastName",o.cotUser.lastName,{expires:i}),this._cookie("division",o.cotUser.division,{expires:i}),this._cookie("groups",o.cotUser.groupMemberships,{expires:i})),this._loadSessionFromCookie()},CotSession.prototype._cookie=function(o,i,s){return o&&(o=encodeURIComponent(this.options.appName)+"."+o),$.cookie(o,i,s)},CotSession.prototype._removeCookie=function(o){return $.removeCookie(encodeURIComponent(this.options.appName)+"."+o)};